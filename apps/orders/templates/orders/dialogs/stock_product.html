<div class="container">
    <div class="row">
        <div class="col">

            <table id="product_table" class="table table-hover table-sm table-striped"
                   style="width:100%">
                <thead>
                <tr>
                    <th width="75px">Image</th>
                    <th class="col-2">Code</th>
                    <th class="col-4">Name</th>
                    <th class="col-auto">Title</th>
                </tr>
                </thead>
            </table>

        </div>
    </div>
    <div class="row mb-3">
        <div class="col">
            <table id="core_variants_table" class="table table-hover table-sm table-striped"
                   style="width:100%">
                <thead>
                <tr>
                    <th width="col-1">Code</th>
                    <th class="col-4">Size</th>
                    <th class="col-4">Material</th>
                    <th class="col-1">Price</th>
                </tr>
                </thead>
            </table>
        </div>
    </div>
    <div class="row">
        <div class="col-12">
            <form method="post" action="{% url 'orderproductadd' order_id %}" class="js-product-add" id="form-stock">
                {% csrf_token %}
                <input type="hidden" id="{{ form.order.name }}" name="{{ form.order.name }}" value="{{ order_id }}">
                <input type="hidden" id="{{ form.product_id.name }}" name="{{ form.product_id.name }}">
                <input type="hidden" id="{{ form.product_variant.name }}" name="{{ form.product_variant.name }}">
                <input type="hidden" id="{{ form.name.name }}" name="{{ form.name.name }}">
                <input type="hidden" id="{{ form.model.name }}" name="{{ form.model.name }}">
                <input type="hidden" id="{{ form.size_name.name }}" name="{{ form.size_name.name }}">
                <input type="hidden" id="{{ form.material_name.name }}" name="{{ form.material_name.name }}">
                <input type="hidden" id="{{ form.orientation_name.name }}" name="{{ form.orientation_name.name }}">
                <input type="hidden" id="{{ form.status.name }}" name="{{ form.status.name }}" value="1">
                <input type="hidden" id="{{ form.is_bespoke.name }}" name="{{ form.is_bespoke.name }}" value="0">
                <input type="hidden" id="single_unit_price" name="single_unit_price" value="0">

                <input type="hidden" id="{{ form.total.name }}" name="{{ form.total.name }}"
                       value="{{ form.total.value|floatformat:2 }}">
                <input type="hidden" id="{{ form.tax.name }}" name="{{ form.tax.name }}"
                       value="{{ form.tax.value|floatformat:2 }}">


                <div class="row">
                    <div class="col-8">
                        <div class="form-check form-switch">
                            <input class="form-check-input switchApplyBulk" type="checkbox" id="switchApplyBulk"
                                   checked>
                            <label class="form-check-label" for="stock-switchShowBulk">Apply bulk discount</label>
                        </div>
                        <div class="collapse show" id="collapseBulkDiscount">
                            <div class="row">
                                <div class="col-12" id="bulkTableDiv">
                                    <select class="form-select bulk_group_select" id="stock-bulk_group_select">
                                        {% for bulk_group in bulk_info %}
                                            <option value="{{ bulk_group.id }}">{{ bulk_group.name }}</option>
                                        {% endfor %}
                                    </select>
                                    <div class="row">
                                        <div class="col-xs-12" id="bulk_pricing_div">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="row">
                            <div class="row d-flex justify-content-md-end mb-2">
                                <div class="col-6 col-lg-4">

                                    <label for="{{ form.quantity.name }}"
                                           class="form-label">{{ form.quantity.label }}</label>
                                    <input type="number" min="1" step="1" class="form-control calc_line_totals"
                                           id="{{ form.quantity.name }}" name="{{ form.quantity.name }}"
                                           value="1">
                                </div>
                                <div class="col-6 col-lg-4">
                                    <label for="{{ form.price.name }}"
                                           class="form-label">{{ form.price.name }}</label>
                                    <input type="number" id="{{ form.price.name }}" name="{{ form.price.name }}"
                                           step="0.01"
                                           value="{{ form.price.value|floatformat:2 }}"
                                           class="form-control calc_line_totals" readonly>
                                </div>
                                <div class="col-12 col-lg-4 d-flex align-items-end text-end">
                                    <h3>Â£<span id="line_total_cal">{{ form.total.value|floatformat:2 }}</span></h3>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            <div class="row">
                            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                <button type="button" data-bs-dismiss="modal" class="btn btn-danger ">Close</button>
                                <button type="submit" id="submit" class="btn btn-success pull-right">Add</button>
                            </div>
                        </div>

            </form>
        </div>
    </div>

</div>

{% block javascript %}

    <style>
        .cards tbody tr {
            float: left;
            width: 10rem;
            margin: 0.5rem;
            border: 0.0625rem solid rgba(0, 0, 0, .125);
            border-radius: .25rem;
            box-shadow: 0.25rem 0.25rem 0.5rem rgba(0, 0, 0, 0.25);
        }

        .cards tbody td {
            display: block;
        }

        .table tbody label {
            display: none;
        }

        .cards tbody label {
            display: inline;
            position: relative;
            font-size: 85%;
            top: -0.5rem;
            float: left;
            color: #808080;
            min-width: 4rem;
            margin-left: 0;
            margin-right: 1rem;
            text-align: left;
        }

        #product_table.cards .product-thumb {
            height: 50px;
        }

        #product_table .product-thumb {
            height: 30px;
        }

        tr.selected label {
            color: #404040;
        }

        .table .fa {
            font-size: 2.5rem;
            text-align: center;
        }

        .cards .fa {
            font-size: 7.5rem;
        }

    </style>


    <script>
        $(document).ready(function () {

            var product_table = $('#product_table').DataTable({
                "dom": "<'row'<'col-6'fl><'col-6'p>>" +
                    "<'row'<'col-12'tr>>",
                "processing": true,
                "lengthMenu": [[10, 25, 50, 100, -1], [10, 25, 50, 100, "All"]],
                "pageLength": 10,
                "autoWidth": false,
                "responsive": false,
                "serverSide": true,
                "select": true,
                "scroller": true,
                scrollY: 300,
                "rowId": 'product_id',
                "ajax": {
                    "processing": true,
                    "url": "/products/api/post-list/products/?format=datatables",
                    "type": "POST",
                    "beforeSend": function (xhr) {
                        xhr.setRequestHeader("X-CSRFToken", "{{ csrf_token|escapejs }}");
                    }
                },
                "deferRender": false,

                "search": {
                    "regex": true
                },
                columns: [

                    {
                        data: "image_url",
                        name: "thumbnail",
                        searchable: "false",
                        sortable: "false",
                        render: function (data, type, row, meta) {
                            return '<img class="rounded mx-auto d-block product-thumb" src="' + data + '">';
                        }
                    },
                    {data: "model"},
                    {
                        data: "productdescbase.name",
                        defaultContent: ""
                    },
                    {
                        data: "productdescbase.title",
                        defaultContent: ""
                    },
                    {
                        data: "productdescbase.description",
                        defaultContent: "",
                        "visible": false
                    },
                    {
                        data: "product_id",
                        "visible": false
                    },
                    {
                        data: "corevariants",
                        name: "corevariants.supplier_code",
                        "visible": false
                    }
                ]
            });

            product_table.on('select', function (e, dt, type, indexes) {
                if (type === 'row') {
                    let product_id = product_table.row(indexes).id()
                    set_variant_url(product_id)
                    set_product_details(product_table.row(indexes).data())

                }
            });


            let core_vars_tbl = $('#core_variants_table').DataTable({
                "processing": true,
                "pageLength": 100,
                "paging": true,
                "info": false,
                "autoWidth": false,
                "searching": false,
                "responsive": true,
                "select": true,
                "deferRender": false,
                "scroller": true,
                scrollY: 200,
                "rowId": 'prod_variant_core_id',
                "ajax": {
                    "processing": true,
                    "url": "/products/api/storevariants/" + 1 + "/1?format=datatables",
                },
                columns: [
                    {data: "variant_code"},
                    {
                        data: "prod_var_core.size_material.product_size.size_name"
                    },
                    {
                        data: "prod_var_core.size_material.product_material.material_name"
                    },
                    {
                        data: null,
                        render: function (data, type, row, meta) {
                            if (data['variant_overide_price'] > 0)
                                return data['variant_overide_price']
                            else
                                return data['prod_var_core']['size_material']['price']
                        },
                        name: 'variant_price'
                    }
                ]

            })

            function set_variant_url(product_id) {
                let ajax_url = "/products/api/storevariants/" + product_id + "/1?format=datatables"
                core_vars_tbl.ajax.url(ajax_url).load();
            }

            product_table.on('draw', function () {
                product_table.row(0).select();

            });

            core_vars_tbl.on('draw', function () {
                core_vars_tbl.row(0).select();
            });

            core_vars_tbl.on('select', function (e, dt, type, indexes) {
                if (type === 'row') {
                    let product_variant_id = core_vars_tbl.row(indexes).id()
                    set_product_variant_details(core_vars_tbl.row(indexes).data())
                    SetPrice(true, '#form-stock')
                }
            });

            function set_product_details(data_row) {

                $('#form-stock #{{ form.product_id.name }}').val(data_row['product_id'])
                $('#form-stock #{{ form.name.name }}').val(data_row['productdescbase']['name'])
            }

            function set_product_variant_details(data_row) {
                console.log(data_row);
                let core_variant = data_row['prod_var_core'];
                $('#form-stock #{{ form.size_name.name }}').val(core_variant['size_material']['product_size']['size_name'])
                $('#form-stock #{{ form.material_name.name }}').val(core_variant['size_material']['product_material']['material_name'])
                $('#form-stock #{{ form.orientation_name.name }}').val(core_variant['size_material']['product_size']['orientation']['orientation_name'])
                $('#form-stock #{{ form.product_variant.name }}').val(core_variant['prod_variant_core_id'])
                $('#form-stock #{{ form.model.name }}').val(data_row['variant_code'])
                if (data_row['variant_overide_price'] > 0) {
                    $('#form-stock #{{ form.price.name }}').val(data_row['variant_overide_price'])
                } else {
                    $('#form-stock #{{ form.price.name }}').val(core_variant['size_material']['price'])
                }
                $('#form-stock #single_unit_price').val($('#{{ form.price.name }}').val())
            }
        });


    </script>

{% endblock javascript %}