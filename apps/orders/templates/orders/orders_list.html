{% extends 'partials/base.html' %}
{% load static %}
{% block extra_css %}

{% endblock extra_css %}

{% block content %}
    <div class="row">
                    <div class="col-lg-12 ">
                        <div class="ibox">
                            <div class="ibox-content">
                                <table id="order_table" class="table table-hover table-striped align-middle table-sm" style="width:100%">
                                    <thead>
                                    <tr>
                                        <th width="50px">Website</th>
                                        <th >Order</th>
                                        <th >Date</th>
                                        <th >Day</th>
                                        <th >Company</th>
                                        <th >Contact</th>
                                        <th >£ Method</th>
                                        <th >£ Status</th>
                                        <th >Status</th>
                                        <th>Flags</th>
                                        <th class="col-1">Total</th>
                                        <th class="text-end">&nbsp;</th>
                                    </tr>
                                    </thead>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

{% endblock content %}

{% block javascript %}

{% include 'partials/javascript.html' %}


    <script>
    $(document).ready(function() {

    if ( $.fn.dataTable.isDataTable( '#order_table' ) ) {
        let order_table = $('#order_table').DataTable();
    }
    else {
        let order_table = $('#order_table').DataTable( {
        "dom": "<'row'<'col-10'f><'col-2'l>>" +
                 "<'row'<'col-sm-12' tr>>" +
                 "<'row'<'col-sm-6'i><'col-sm-6' p>>",
        "processing" : true,
        "lengthMenu" : [[10,25,50,100,-1], [10,25,50,100,"All"]],
        "pageLength": 25,
        "autoWidth": false,
        "responsive": true,
        "serverSide": true,
        "rowId" : 'order_id',
        "ajax": {
                 "processing": true,
                "url": "/orders/api/orders?format=datatables&status={{ order_status }}",
            },
        "deferRender": false,
        "order": [[ 1, "desc" ]],
        "search": {
                 "smart": true
             },
        columns :[

            {
                data: "store",
                sortable: false,
                searchable: false,
                name: "store.name",
                class: "align-middle",
                render: function ( data, type, row ) {
                    let image_src = '{% static "images/stores/" %}' + data.thumb;
                    let store_logo = '<img height="15px" src="' + image_src + '">';
                    //return '<img height="15px" src="' + image_src + '">'
                    let order_type_icon = row['order_type']['order_type_icon']
                    return store_logo + ' ' + order_type_icon;
                 }
            },
            {
                data: "order_id",
                 render: function ( data, type, row ) {
                    let url = '/orders/' + data;
                    let website_prefix = row['store']['prefix']+'-';
                    return '<a href="' + url + '">'+ data + '</a>';
                 }
            },
            {
                data: "short_date",
                searchable: false
            },

            {
                data: "dow",
                 render: function ( data, type, row ) {
                    let text = data + ' (' + row.days_since_order + ')'
                     return text
                 },
                searchable: false

            },
            {
                data: "payment_company",
                render : function (data, type, row) {
                    if(data) {
                        if(row['customer']){
                            let url = '/customer/details/' + row['customer']['customer_id']
                            return '<a href="' + url + '">'+ data + '</a>';
                        }
                        else {
                            return data
                        }
                    }else
                        return ""
                },
                searchable: true
            },
            {
                data: "payment_fullname",
                render : function (data, type, row) {
                    if(data) {
                        if(row['customer']){
                            let url = '/customer/details/' + row['customer']['customer_id']
                            return '<a href="' + url + '">'+ data + '</a>';
                        }
                        else {
                            return data
                        }
                    }else
                        return ""
                },
            },
            {
                data: "payment_method.payment_method_name",
            },
            {
                data: "payment_status.name",
            },
            {
                data: "order_status.name",
            },
            {
                data: "orderflags",
                searchable: false,
                render: function (data, type, row){
                    let flags = "";
                    if(data.length > 0){
                        flags = '<ul class="list-inline order-flags">';
                        for (let index = 0, len = data.length; index < len; ++index) {
                            let flagnew = '';
                            flagnew = '<li class="list-inline-item"><i class="' + data[index].flag['flag_icon'] + '"></i></li>'
                            flags += flagnew
                        }

                    }
                    let product_flags = row.product_flags;
                    if(product_flags.length > 0){
                        if(data.length <= 0) {
                            flags = '<ul class="list-inline order-flags">';
                        }
                        for (let index = 0, len = product_flags.length; index < len; ++index) {
                            let flagnew = '';
                            flagnew = '<li class="list-inline-item"><i class="' + product_flags[index]['status__icon_path'] + '"></i></li>'
                            flags += flagnew
                        }
                    }
                    flags += '</ul>'
                    return flags
                }
            },
            {
                data: "total",
                class: "text-end",
                render: function ( data, type, row ) {
                    return parseFloat(data).toFixed(2);
                 }
            },
            {
                data: "order_id",
                sortable: false,
                className: 'text-end',
                render: function ( data, type, row ) {

                     //let edit_icon = '<a class="btn btn-primary btn-sm" role="button" href="' + data + '"><i class="{{ ICON_EDIT }} fa-sm"></i></a>';
                   // let delete_icon = '<a class="btn btn-danger btn-sm" role="button" href="' + data +'/delete/"><i class="{{ ICON_DELETE }} fa-sm"></i></a>'
                    let shipping_colour = 'btn-grey'
                    if(row['shipping_flag'] != null){
                        shipping_colour = 'btn-' + row['shipping_flag']['shipping_status__status_colour']
                    }
                   // let shipping_icon = '<i class="fa-solid fa-shipping-fast ' + shipping_colour + ' "></i>'

                    let printed_colour = 'btn-grey'
                    if(row['printed'] == 1){
                        printed_colour = 'btn-green'
                    }
                   // let printed_icon = '<i class="fa-solid fa-print ' + printed_colour + ' "></i>'


                    //return printed_icon + " " + shipping_icon + /* " " + delete_icon + "  " +*/ edit_icon;
                    let btn_grp = '<div class="btn-group" role="group" aria-label="Order status">'
                        let printed_icon = '<button type="button" class="btn btn-sm ' + printed_colour +  '" disabled><i class="fa-solid fa-print  "></i></button>'
                        let shipping_icon = '<button type="button" class="btn btn-sm '+ shipping_colour + '" disabled><i class="fa-solid fa-shipping-fast "></i></button>'
                        let edit_icon = '<a class="btn {{ BUTTON_EDIT }} btn-sm" role="button" href="' + data + '"><i class="{{ ICON_EDIT }} "></i></a>'
                    return btn_grp + shipping_icon + printed_icon + edit_icon +'</div>'
                }
            },
           {data: "payment_email", "visible": false},
            {data: "printed", "visible": false, searchable: false},
            {data: "shipping_flag", "visible": false, searchable: false},
           {data: "payment_telephone", "visible": false},
           {data: "payment_address_1", "visible": false},
           {data: "payment_postcode", "visible": false},
           {data: "shipping_fullname", "visible": false},
           {data: "shipping_email", "visible": false},
           {data: "shipping_telephone", "visible": false},
           {data: "payment_address_1", "visible": false},
           {data: "payment_postcode", "visible": false},
           {data: "customer_order_ref", "visible": false},
           {data: "customer", "visible": false, searchable: false},
           {data: "days_since_order", "visible": false, searchable: false },
           {data: "product_flags", "visible": false, searchable: false },
           {data: "highlight_code", "visible": false, searchable: false },
            {data: "order_type", "visible": false, searchable: false },
        ],
        "createdRow": function( row, data, dataIndex ) {
           /* if ( data.order_status.order_status_id != 15 ) {
                $(row).addClass( 'failed-order' );
            } */
            if(data.shipping_flag == null) {
                if (data.highlight_code == 1) {
                    $(row).addClass('live-order');
                }
                if (data.highlight_code == 2) {
                    $(row).addClass('pending-order');
                }
                if (data.highlight_code == 3) {
                    $(row).addClass('failed-order');
                }
            }
         },
    } );
    }




} );

</script>

{% endblock javascript %}

