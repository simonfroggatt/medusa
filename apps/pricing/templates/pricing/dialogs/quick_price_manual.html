<form method="post" id="form-quick_manual"
      action="{{ form_post_url }}"
        {% if price_for|upper == "I" %} class="js-product-add"
        {% else %}
      class="js-quote-add"
        {% endif %}
>
    <h4>Known size and price</h4>
    <div class="row pb-2">
        <div class="col-4">
            <label for="manualWidth" class="form-label">Width</label>
            <input type="number" class="form-control" id="manualWidth" min="0" placeholder="0" onchange="reCalc()">
        </div>
        <div class="col-4">
            <label for="manualHeight" class="form-label">Height</label>
            <input type="number" class="form-control" id="manualHeight" min="0" placeholder="0" onchange="reCalc()">
        </div>
        <div class="col-4">
            <label for="manualPrice" class="form-label">Price</label>
            <input type="number" class="form-control" id="manualPrice" step="0.01" min="0" placeholder="0"
                   onchange="reCalc()">
        </div>
    </div>
<hr>
    <div><h4>Size you want</h4> <div class="form-switch form-check">
                <input class="form-check-input switchScale" type="checkbox" id="switchScale"
                       >
                <label class="form-check-label" for="switchScale">Lock Aspect</label>
            </div>
    </div>
    <div class="row pb-2">
        <div class="col-4">
            <label for="manualCalcWidth" class="form-label">Width</label>
            <input type="number" class="form-control" id="manualCalcWidth" min="0" placeholder="0">

        </div>
        <div class="col-4">
            <label for="manualCalcHeight" class="form-label">Height</label>
            <input type="number" class="form-control" id="manualCalcHeight" min="0" placeholder="0">
        </div>
        <div class="col-4">
            <label for="manualMaterial" class="form-label">Material</label>
            <input class="form-control" list="datalistMaterials" id="manualMaterial"
                   placeholder="Type to search..." onchange="reCalc()">
            <datalist id="datalistMaterials">
                {% for materials in material_obj %}
                    <option value="{{ materials.material_name }}"
                            data-materialid="{{ materials.material_id }}"></option>
                {% endfor %}
            </datalist>
        </div>
    </div>
<div class="row">
        {% if price_for|upper == "I" or price_for|upper == "Q" %}
            <input type="hidden" id="{{ form.is_bespoke.name }}" name="{{ form.is_bespoke.name }}" value="True">
            <input type="hidden" id="{{ form.product_id.name }}" name="{{ form.product_id.name }}" value="0">
            <input type="hidden" id="{{ form.product_variant.name }}" name="{{ form.product_variant.name }}"
                   value=null>
            <input type="hidden" class="form-control" id="{{ form.size_name.name }}"
                   name="{{ form.size_name.name }}" value="{{ form.size_name.value }}">
            <input type="hidden" id="{{ form.total.name }}" name="{{ form.total.name }}"
                       value="{{ form.total.value|floatformat:2 }}">
            <input type="hidden" id="{{ form.tax.name }}" name="{{ form.tax.name }}"
                       value="{{ form.tax.value|floatformat:2 }}">

            <div class="col-4">
                <label for="{{ form.model.name }}" class="form-label">{{ form.model.label }}</label>
                <input type="text" class="form-control" id="{{ form.model.name }}"
                       name="{{ form.model.name }}" value="BESPOKE">
            </div>
            <div class="col-8">
                <label for="{{ form.name.name }}" class="form-label">{{ form.name.label }}</label>
                <input type="text" class="form-control" id="{{ form.name.name }}"
                       name="{{ form.name.name }}" value="{{ form.name.value }}">
            </div>
            </div>
        {% endif %}
    {% csrf_token %}
    <input type="hidden" id="single_unit_price" name="single_unit_price" value="0">
    <input type="hidden" id="text_to_copy" name="text_to_copy" value="">
    <input type="hidden" id="price_to_copy" name="price_to_copy" value="">
    <input id="string_to_copy_manual" name="string_to_copy_manual" class="hidden_copy" value="">

    {% csrf_token %}
    {% if price_for|upper == "I" %}
        <input type="hidden" id="{{ form.order.name }}" name="{{ form.order.name }}" value="{{ order_id }}">
        <input type="hidden" id="{{ form.status.name }}" name="{{ form.status.name }}" value="1">

    {% else %}
        <input type="hidden" id="{{ form.quote.name }}" name="{{ form.quote.name }}" value="{{ quote_id }}">
    {% endif %}


<hr>
    <div class="row">
        <div class="col-8">
            <div class="form-check form-switch">
                <input class="form-check-input switchApplyBulk" type="checkbox" id="switchApplyBulk"
                       checked>
                <label class="form-check-label" for="stock-switchShowBulk">Apply bulk discount</label>
            </div>
            <div class="collapse show" id="collapseBulkDiscount">
                <div class="row">
                    <div class="col-12" id="bulkTableDiv">
                        <select class="form-select bulk_group_select" id="stock-bulk_group_select">
                            {% for bulk_group in bulk_info %}
                                <option value="{{ bulk_group.id }}">{{ bulk_group.name }}</option>
                            {% endfor %}
                        </select>
                        <div class="row">
                            <div class="col-xs-12" id="bulk_pricing_div">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-4">
            <div class="row">
                <div class="row d-flex justify-content-md-end mb-2">
                    <div class="col-6 col-lg-4">

                        <label for="quantity"
                               class="form-label">QTY</label>
                        <input type="number" min="1" step="1" class="form-control calc_line_totals"
                               id="quantity" name="quantity"
                               value="1">
                    </div>
                    <div class="col-6 col-lg-4">
                        <label for="price"
                               class="form-label">Price</label>
                        <input type="number" id="price" name="price"
                               step="0.01"
                               value="0.00"
                               class="form-control calc_line_totals" readonly>
                    </div>
                    <div class="col-12 col-lg-4 d-flex align-items-end text-end">
                        <h3>£<span id="line_total_cal">0.00</span></h3>
                    </div>
                </div>
            </div>
            {% if price_for|upper == "Q" or price_for|upper == "I" %}
                <div class="row">
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <button type="button" data-bs-dismiss="modal" class="btn btn-danger ">Close</button>
                        <button type="submit" id="submit" class="btn btn-success pull-right">Add</button>
                    </div>
                </div>
            {% else %}
                <div class="row">
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">

                        <button type="button" class="btn btn-success pull-right btncopy"
                                data-clipboard-target="#string_to_copy_manual">Copy Price
                        </button>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>

</form>

<script>

    function reCalc() {
        let width = $('#manualWidth').val() ? $('#manualWidth').val() : 0;
        let height = $('#manualHeight').val() ? $('#manualHeight').val() : 0;
        let price = $('#manualPrice').val() ? $('#manualPrice').val() : 0;

        let calc_width = $('#manualCalcWidth').val()
        let calc_height = $('#manualCalcHeight').val()


        let m2 = (width / 1000) * (height / 1000)
        let cpstperm2 = 0
        if (m2 > 0) {
            cpstperm2 = price / m2
        }

        let newprice = (calc_width / 1000) * (calc_height / 1000) * cpstperm2
        $('#form-quick_manual #single_unit_price').val(parseFloat(newprice).toFixed(2));
        $('#form-quick_manual #price').val(parseFloat(newprice).toFixed(2));


        let size_name = calc_width + 'mm x ' + calc_height + 'mm ' + $('#form-quick_manual #manualMaterial').val()
        $('#form-quick_manual #text_to_copy').val(size_name);

        if($('#form-quick_manual #size_name').length) {
            $('#form-quick_manual #size_name').val(calc_width + 'mm x ' + calc_height + 'mm ')
        }

        if($('#form-quick_manual #product_variant').length) {
            $('#form-quick_manual #product_variant').val(null)
        }

        if($('#form-quick_manual #material_name').length) {
            $('#form-quick_manual #material_name').val($('#form-quick_manual #manualMaterial').val())
        }

        if (newprice > 0) {
            SetPrice(true, '#form-quick_manual')
        }
    }

    $(document).ready(function () {


        function set_copy_price(form_id) {
            let price_string = "";
            let price_str = $(form_id + ' #price').val();
            let qty_str = $(form_id + ' #quantity').val();

            price_string = " @ £" + price_str + " each for " + qty_str + " off";
            $(form_id + ' #price_to_copy').val(price_string);

        }

        function set_copy_material() {
            let width = $('#manualCalcWidth').val() ? $('#manualCalcWidth').val() : 0;
            let height = $('#manualCalcHeight').val() ? $('#manualCalcHeight').val() : 0;
            $('#form-quick_manual #text_to_copy').val(width + 'mm x ' + height + 'mm ' + $('#form-quick_manual #manualMaterial').val());
        }

        $('#form-quick_manual #line_total_cal').change(function () {
            set_copy_price('#form-quick_manual');
            set_copy_material();
            let final_copy_str = $('#form-quick_manual #text_to_copy').val() + $('#form-quick_manual #price_to_copy').val()
            $('#string_to_copy_manual').val(final_copy_str);
        });

        $(document).on('focusin', '#manualCalcHeight', function () {
            $(this).data('val', $(this).val() ? $(this).val() : 0);
        });

        $(document).on('change', '#manualCalcHeight', function () {
            var prev = $(this).data('val')
            var current = $(this).val();

            var keep_aspect = $('#switchScale').is(':checked');
            if (keep_aspect) {
                let oldwidth = $('#manualCalcWidth').val()
                let aspect = oldwidth / prev;
                let newwidth = Math.round(aspect * current)
                $('#manualCalcWidth').val(newwidth)
            }
            reCalc()
        });

        $(document).on('focusin', '#manualCalcWidth', function () {
            $(this).data('val', $(this).val() ? $(this).val() : 0);
        });

        $(document).on('change', '#manualCalcWidth', function () {
            var prev = $(this).data('val')
            var current = $(this).val();

            var keep_aspect = $('#switchScale').is(':checked');
            if (keep_aspect) {
                let oldwidth = $('#manualCalcHeight').val()
                let aspect = oldwidth / prev;
                let newwidth = Math.round(aspect * current)
                $('#manualCalcHeight').val(newwidth)
            }
            reCalc()
        });


    });

</script>
